<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réinitialiser mot de passe - Euduka</title>
    <link rel="stylesheet" href="mdp-reinitialiser.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css">
</head>

<body>
    <div class="mdp-reinitialiser-page">
        <div class="modal-mdp-reinitialiser">
            <h2>Réinitialisation de mot de passe</h2>

            <div id="form-container">
                <p style="text-align: center; color: var(--sec); margin-bottom: 25px;">
                    Entrez votre nouveau mot de passe
                </p>

                <div class="input-group">
                    <input type="password" id="new-password" placeholder="Nouveau mot de passe" />
                    <span class="password-toggle" data-target="new-password">
                        <i class="fas fa-eye"></i>
                    </span>
                    <div class="error-message" id="new-password-error"></div>
                </div>

                <div class="input-group">
                    <input type="password" id="confirm-password" placeholder="Confirmer le mot de passe" />
                    <span class="password-toggle" data-target="confirm-password">
                        <i class="fas fa-eye"></i>
                    </span>
                    <div class="error-message" id="confirm-password-error"></div>
                </div>

                <button id="reset-password-btn">Réinitialiser le mot de passe</button>
            </div>

            <div id="success-container" style="display: none;">
                <div class="success-message">
                    <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>Mot de passe réinitialisé !</h3>
                    <p>Vous allez être redirigé vers la page de connexion...</p>
                </div>
            </div>

            <div id="error-container" style="display: none;">
                <div class="token-expired">
                    <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>Erreur</h3>
                    <p id="error-message"></p>
                    <a href="index.html" class="valider" style="display: inline-block; text-decoration: none;">
                        Retour à l'accueil
                    </a>
                </div>
            </div>

            <div class="back-login" id="back-login" style="display: none;">
                <a href="index.html">Retour à la connexion</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { API_URL } from './config/env.js';
        import { safeFetchPostWithLoader } from './utils/api.js';

        let token = null;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            token = urlParams.get('token');

            if (!token) {
                showError('Lien de réinitialisation invalide ou expiré.');
                return;
            }

            initEventListeners();
        });

        function initEventListeners() {
            const resetBtn = document.getElementById('reset-password-btn');
            resetBtn.addEventListener('click', handleResetPassword);

            const passwordToggles = document.querySelectorAll('.password-toggle');
            passwordToggles.forEach(toggle => {
                toggle.addEventListener('click', () => togglePassword(toggle));
            });

            const newPasswordInput = document.getElementById('new-password');
            newPasswordInput.addEventListener('input', () => clearError('new-password'));
            newPasswordInput.addEventListener('blur', validatePassword);

            const confirmPasswordInput = document.getElementById('confirm-password');
            confirmPasswordInput.addEventListener('input', () => clearError('confirm-password'));
            confirmPasswordInput.addEventListener('blur', validateConfirmPassword);
        }

        function validatePassword() {
            const password = document.getElementById('new-password').value;

            if (password.length < 4) {
                showFieldError('new-password', 'Le mot de passe doit contenir au moins 4 caractères');
                return false;
            }

            if (password.length > 50) {
                showFieldError('new-password', 'Le mot de passe ne peut pas dépasser 50 caractères');
                return false;
            }

            clearError('new-password');
            return true;
        }

        function validateConfirmPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showFieldError('confirm-password', 'Les mots de passe ne correspondent pas');
                return false;
            }

            clearError('confirm-password');
            return true;
        }

        function showFieldError(fieldId, message) {
            const input = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + '-error');

            input.classList.add('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function clearError(fieldId) {
            const input = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + '-error');

            input.classList.remove('error');
            errorDiv.classList.remove('show');
        }

        function togglePassword(toggle) {
            const input = document.getElementById(toggle.dataset.target);
            const icon = toggle.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        async function handleResetPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            let isValid = true;

            if (!newPassword) {
                showFieldError('new-password', 'Le nouveau mot de passe est requis');
                isValid = false;
            }

            if (!confirmPassword) {
                showFieldError('confirm-password', 'Veuillez confirmer votre mot de passe');
                isValid = false;
            }

            if (!validatePassword()) isValid = false;
            if (!validateConfirmPassword()) isValid = false;

            if (!isValid) return;

            const resetBtn = document.getElementById('reset-password-btn');
            resetBtn.disabled = true;
            resetBtn.textContent = 'Réinitialisation...';

            try {
                const result = await safeFetchPostWithLoader(API_URL + '/mdp-reinitialiser', {
                    token: token,
                    newPassword: newPassword
                });

                if (result.success) {
                    showSuccess();
                } else {
                    showError(result.error || 'Une erreur est survenue');
                }

            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion. Veuillez réessayer.');
            } finally {
                resetBtn.disabled = false;
                resetBtn.textContent = 'Réinitialiser le mot de passe';
            }
        }

        function showSuccess() {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('success-container').style.display = 'block';

            setTimeout(() => {
                window.location.href = 'index.html';
            }, 3000);
        }

        function showError(message) {
            document.getElementById('form-container').style.display = 'none';
            document.getElementById('error-container').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }
    </script>
</body>

</html>
